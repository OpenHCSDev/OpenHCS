"""
OpenHCS Pipeline - Converted from CellProfiler
Source: ExampleHuman.cppipe

Auto-generated by CellProfiler â†’ OpenHCS converter.
"""

import numpy as np
from typing import Tuple, List, Optional, Dict, Any
from dataclasses import dataclass
from enum import Enum

# OpenHCS imports
from openhcs.core.steps.function_step import FunctionStep
from openhcs.core.config import LazyProcessingConfig
from openhcs.constants.constants import VariableComponents, GroupBy

# Absorbed CellProfiler functions (dynamically loaded)
from benchmark.cellprofiler_library import get_function

identify_primary_objects = get_function("IdentifyPrimaryObjects")
identify_secondary_objects = get_function("IdentifySecondaryObjects")
measure_object_intensity = get_function("MeasureObjectIntensity")
measure_object_size_shape = get_function("MeasureObjectSizeShape")

# Pipeline Steps
# Settings from .cppipe are bound as default parameters
# variable_components derived from LLM-inferred category
pipeline_steps = [
    FunctionStep(
        func=(identify_primary_objects, {
            'min_diameter': 8,
            'max_diameter': 80,
            'exclude_size': True,
            'exclude_border_objects': True,
            'unclump_method': 'Intensity',
            'watershed_method': 'Intensity',
            'smoothing_filter_size': 10,
            'maxima_suppression_size': 7.0,
            'low_res_maxima': True,
            'fill_holes': 'After declumping only',
            'automatic_smoothing': True,
            'automatic_suppression': True,
            'limit_erase': 'Continue',
            'maximum_object_count': 500,
            'threshold_correction_factor': 1.0,
        }),
        name="IdentifyPrimaryObjects",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Unmapped settings:
        # display_accepted_local_maxima=False
        # select_maxima_color='Blue'
        # use_advanced_settings=False
    ),
    FunctionStep(
        func=(identify_secondary_objects, {
            'method': 'Propagation',
            'expansion_distance': 10,
            'regularization': 0.05,
            'exclude_border_objects': False,
            'discard_primary': False,
            'fill_holes': True,
            'threshold_strategy': 'Global',
            'threshold_method': 'Otsu',
            'threshold_smoothing_scale': 0.0,
            'threshold_correction_factor': 0.8,
        }),
        name="IdentifySecondaryObjects",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Unmapped settings:
        # lower_and_upper_bounds_on_threshold=(0.0, 1.0)
        # manual_threshold=0.0
        # select_the_measurement_to_threshold_with='None'
    ),
    FunctionStep(
        func=measure_object_intensity,
        name="MeasureObjectIntensity",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
    ),
    FunctionStep(
        func=(measure_object_size_shape, {
            'calculate_zernikes': True,
            'calculate_advanced': False,
        }),
        name="MeasureObjectSizeShape",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
    ),
]