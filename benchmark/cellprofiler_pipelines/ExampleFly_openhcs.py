"""
OpenHCS Pipeline - Converted from CellProfiler
Source: ExampleFly.cppipe

Auto-generated by CellProfiler → OpenHCS converter.
"""

import numpy as np
from typing import Tuple, List, Optional, Dict, Any
from dataclasses import dataclass
from enum import Enum

# OpenHCS imports
from openhcs.core.steps.function_step import FunctionStep
from openhcs.core.config import LazyProcessingConfig
from openhcs.constants.constants import VariableComponents, GroupBy
from openhcs.core.memory.decorators import numpy
from openhcs.processing.backends.lib_registry.unified_registry import ProcessingContract
from openhcs.core.pipeline.function_contracts import special_outputs
from openhcs.processing.materialization import csv_materializer


# Skipped infrastructure modules (handled by OpenHCS):
#   - LoadData → handled by plate_path + openhcs_metadata.json
#   - ExportToSpreadsheet → handled by @special_outputs(csv_materializer(...))

# Absorbed CellProfiler functions
from benchmark.cellprofiler_library import (
    identify_primary_objects,
    identify_secondary_objects,
    identify_tertiary_objects,
    measure_object_size_shape,
    measure_object_intensity,
    measure_texture,
    measure_object_neighbors,
    measure_colocalization,
    measure_image_intensity,
)

# Pipeline Steps
# Settings from .cppipe are bound as default parameters
# variable_components derived from LLM-inferred category
pipeline_steps = [
    FunctionStep(
        func=identify_primary_objects,
        name="IdentifyPrimaryObjects",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Settings from .cppipe:
        # select_the_input_image='OrigBlue'
        # name_the_primary_objects_to_be_identified='Nuclei'
        # typical_diameter_of_objects_in_pixel_units=(10, 40)
        # discard_objects_outside_the_diameter_range=True
        # discard_objects_touching_the_border_of_the_image=True
    ),
    FunctionStep(
        func=identify_secondary_objects,
        name="IdentifySecondaryObjects",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Settings from .cppipe:
        # select_the_input_objects='Nuclei'
        # name_the_objects_to_be_identified='Cells'
        # select_the_method_to_identify_the_secondary_objects='Propagation'
        # select_the_input_image='OrigGreen'
        # number_of_pixels_by_which_to_expand_the_primary_objects=10
    ),
    FunctionStep(
        func=identify_tertiary_objects,
        name="IdentifyTertiaryObjects",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Settings from .cppipe:
        # select_the_larger_identified_objects='Cells'
        # select_the_smaller_identified_objects='Nuclei'
        # name_the_tertiary_objects_to_be_identified='Cytoplasm'
        # shrink_smaller_object_prior_to_subtraction=True
    ),
    FunctionStep(
        func=measure_object_size_shape,
        name="MeasureObjectSizeShape",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Settings from .cppipe:
        # select_object_sets_to_measure=['Cells', 'Nuclei', 'Cytoplasm']
        # calculate_the_zernike_features=True
        # calculate_the_advanced_features=False
    ),
    FunctionStep(
        func=measure_object_intensity,
        name="MeasureObjectIntensity",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Settings from .cppipe:
        # select_images_to_measure='OrigBlue'
        # select_objects_to_measure=['Nuclei', 'Cells', 'Cytoplasm']
    ),
    FunctionStep(
        func=measure_texture,
        name="MeasureTexture",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Settings from .cppipe:
        # select_images_to_measure='OrigBlue'
        # select_objects_to_measure=['Nuclei', 'Cytoplasm', 'Cells']
        # enter_how_many_gray_levels_to_measure_the_texture_at=256
        # hidden=True
        # measure_whole_images_or_objects='Both'
    ),
    FunctionStep(
        func=measure_object_neighbors,
        name="MeasureObjectNeighbors",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Settings from .cppipe:
        # select_objects_to_measure='Nuclei'
        # select_neighboring_objects_to_measure='Nuclei'
        # method_to_determine_neighbors='Within a specified distance'
        # neighbor_distance=4
        # consider_objects_discarded_for_touching_image_border=True
    ),
    FunctionStep(
        func=measure_colocalization,
        name="MeasureColocalization",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Settings from .cppipe:
        # select_images_to_measure=['OrigBlue', 'OrigGreen']
        # set_threshold_as_percentage_of_maximum_intensity_for_the_images=15.0
        # select_where_to_measure_correlation='Both'
        # select_objects_to_measure='Nuclei'
        # run_all_metrics='Accurate'
    ),
    FunctionStep(
        func=measure_image_intensity,
        name="MeasureImageIntensity",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Settings from .cppipe:
        # select_images_to_measure='OrigBlue'
        # measure_the_intensity_only_from_areas_enclosed_by_objects=False
        # select_input_object_sets=''
        # calculate_custom_percentiles=False
        # specify_percentiles_to_measure=(10, 90)
    ),
]