"""
OpenHCS Pipeline - Converted from CellProfiler
Source: ExampleFly.cppipe

Auto-generated by CellProfiler â†’ OpenHCS converter.
"""

import numpy as np
from typing import Tuple, List, Optional, Dict, Any
from dataclasses import dataclass
from enum import Enum

# OpenHCS imports
from openhcs.core.steps.function_step import FunctionStep
from openhcs.core.config import LazyProcessingConfig
from openhcs.constants.constants import VariableComponents, GroupBy
from openhcs.core.memory.decorators import numpy
from openhcs.processing.backends.lib_registry.unified_registry import ProcessingContract
from openhcs.core.pipeline.function_contracts import special_outputs
from openhcs.processing.materialization import csv_materializer


# Skipped infrastructure modules (handled by OpenHCS):
#   - LoadData -> handled by plate_path + openhcs_metadata.json
#   - ExportToSpreadsheet -> handled by @special_outputs(csv_materializer(...))

# Absorbed CellProfiler functions
from benchmark.cellprofiler_library import (
    identify_primary_objects,
    identify_secondary_objects,
    identify_tertiary_objects,
    measure_object_size_shape,
    measure_object_intensity,
    measure_texture,
    measure_object_neighbors,
    measure_colocalization,
    measure_image_intensity,
)

# Pipeline Steps
# Settings from .cppipe are bound as default parameters
# variable_components derived from LLM-inferred category
pipeline_steps = [
    FunctionStep(
        func=(identify_primary_objects, {
            'min_diameter': 10,
            'max_diameter': 40,
            'exclude_size': True,
            'exclude_border_objects': True,
            'unclump_method': 'Shape',
            'watershed_method': 'Shape',
            'smoothing_filter_size': 10,
            'maxima_suppression_size': 5,
            'low_res_maxima': True,
            'fill_holes': 'After both thresholding and declumping',
            'automatic_smoothing': True,
            'automatic_suppression': True,
            'limit_erase': 'Continue',
            'maximum_object_count': 500,
            'threshold_correction_factor': 1.0,
        }),
        name="IdentifyPrimaryObjects",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Unmapped settings:
        # use_advanced_settings=True
        # threshold_setting_version=12
        # threshold_strategy='Global'
    ),
    FunctionStep(
        func=(identify_secondary_objects, {
            'method': 'Propagation',
            'expansion_distance': 10,
            'regularization': 0.05,
            'exclude_border_objects': False,
            'discard_primary': False,
            'fill_holes': True,
            'threshold_strategy': 'Global',
            'threshold_method': 'Otsu',
            'threshold_smoothing_scale': False,
            'threshold_correction_factor': True,
        }),
        name="IdentifySecondaryObjects",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
        # Unmapped settings:
        # lower_and_upper_bounds_on_threshold=(0, 1)
        # manual_threshold=False
        # select_the_measurement_to_threshold_with='None'
    ),
    FunctionStep(
        func=(identify_tertiary_objects, {
            'secondary_labels': 'Cells',
            'primary_labels': 'Nuclei',
            'shrink_primary': True,
        }),
        name="IdentifyTertiaryObjects",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
    ),
    FunctionStep(
        func=(measure_object_size_shape, {
            'calculate_zernikes': True,
            'calculate_advanced': False,
        }),
        name="MeasureObjectSizeShape",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
    ),
    FunctionStep(
        func=measure_object_intensity,
        name="MeasureObjectIntensity",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
    ),
    FunctionStep(
        func=(measure_texture, {
            'gray_levels': 256,
            'scale': 3,
        }),
        name="MeasureTexture",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
    ),
    FunctionStep(
        func=(measure_object_neighbors, {
            'labels': 'Nuclei',
            'distance_method': 'Within a specified distance',
            'neighbor_distance': 4,
            'neighbors_are_same_objects': True,
        }),
        name="MeasureObjectNeighbors",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
    ),
    FunctionStep(
        func=(measure_colocalization, {
            'scale_max': 15.0,
            'correlation': True,
            'manders_m1': True,
            'rwc1': True,
            'overlap': True,
            'costes_m1': True,
            'fast_mode': 'Fast',
        }),
        name="MeasureColocalization",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.CHANNEL]
        ),
    ),
    FunctionStep(
        func=(measure_image_intensity, {
            'calculate_percentiles': False,
            'percentiles': (10, 90),
        }),
        name="MeasureImageIntensity",
        processing_config=LazyProcessingConfig(
            variable_components=[VariableComponents.SITE]
        ),
    ),
]