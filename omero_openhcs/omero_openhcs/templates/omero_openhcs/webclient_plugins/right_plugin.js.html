<script>
/**
 * OpenHCS Right Panel Plugin
 * 
 * Adds OpenHCS processing tab to OMERO.web right panel.
 * Allows users to submit GPU processing pipelines for plates.
 */

$(function() {
    
    // Initialize the right tab plugin
    $("#openhcs_panel").omeroweb_right_plugin({
        
        // Only enable for single plate selection
        supported_obj_types: ['plate'],
        
        // Load plugin content when plate is selected
        load_tab_content: function(selected, obj_dtype, obj_id) {
            
            // Clear previous content
            $(this).html('<div class="openhcs-loading">Loading OpenHCS panel...</div>');
            
            // Build URL for plugin content
            var plugin_url = '/omero_openhcs/panel/' + obj_id + '/';
            
            // Load the panel HTML
            $(this).load(plugin_url, function(response, status, xhr) {
                if (status == "error") {
                    $(this).html(
                        '<div class="openhcs-error">' +
                        '<h3>Error Loading OpenHCS</h3>' +
                        '<p>Failed to load OpenHCS panel. Make sure the execution server is running.</p>' +
                        '<p>Error: ' + xhr.status + ' ' + xhr.statusText + '</p>' +
                        '</div>'
                    );
                } else {
                    // Initialize the panel after loading
                    initializeOpenHCSPanel(obj_id);
                }
            });
        }
    });
    
});

/**
 * Initialize OpenHCS panel after HTML is loaded
 */
function initializeOpenHCSPanel(plate_id) {

    // Handle submit button click
    $('#openhcs-submit-btn').click(function() {
        submitOpenHCSPipeline(plate_id);
    });

    // Handle example pipeline button
    $('#openhcs-example-btn').click(function() {
        loadExamplePipeline();
    });

    // Start polling server status
    updateServerStatus();
    setInterval(updateServerStatus, 3000);  // Update every 3 seconds
}

/**
 * Submit pipeline to OpenHCS execution server
 */
function submitOpenHCSPipeline(plate_id) {
    
    var pipeline_code = $('#openhcs-pipeline-code').val();
    var config_code = $('#openhcs-config-code').val();
    
    if (!pipeline_code.trim()) {
        alert('Please enter pipeline code');
        return;
    }
    
    // Disable submit button
    $('#openhcs-submit-btn').prop('disabled', true).text('Submitting...');
    
    // Submit to server
    $.ajax({
        url: '/omero_openhcs/submit/' + plate_id + '/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            pipeline_code: pipeline_code,
            config_code: config_code
        }),
        success: function(response) {
            if (response.status === 'ok') {
                var execution_id = response.execution_id;
                $('#openhcs-status').html(
                    '<div class="openhcs-success">' +
                    '<strong>‚úì Pipeline submitted!</strong><br>' +
                    'Execution ID: ' + execution_id + '<br>' +
                    'Status: ' + response.message +
                    '</div>'
                );
                
                // Start polling for status
                pollJobStatus(execution_id);
            } else {
                $('#openhcs-status').html(
                    '<div class="openhcs-error">' +
                    '<strong>‚úó Submission failed</strong><br>' +
                    response.message +
                    '</div>'
                );
            }
        },
        error: function(xhr, status, error) {
            $('#openhcs-status').html(
                '<div class="openhcs-error">' +
                '<strong>‚úó Error submitting pipeline</strong><br>' +
                error +
                '</div>'
            );
        },
        complete: function() {
            $('#openhcs-submit-btn').prop('disabled', false).text('Submit Pipeline');
        }
    });
}

/**
 * Poll job status until complete
 */
function pollJobStatus(execution_id) {
    
    var poll_interval = setInterval(function() {
        
        $.ajax({
            url: '/omero_openhcs/status/' + execution_id + '/',
            method: 'GET',
            success: function(response) {
                
                var status_html = '<div class="openhcs-status-update">';
                status_html += '<strong>Status:</strong> ' + response.status + '<br>';
                
                if (response.status === 'completed') {
                    status_html += '<strong>‚úì Processing complete!</strong><br>';
                    status_html += 'Wells processed: ' + (response.wells_processed || 'N/A') + '<br>';
                    status_html += 'Duration: ' + ((response.end_time - response.start_time) || 'N/A') + 's';
                    clearInterval(poll_interval);
                } else if (response.status === 'error') {
                    status_html += '<strong>‚úó Processing failed</strong><br>';
                    status_html += 'Error: ' + (response.error || 'Unknown error');
                    clearInterval(poll_interval);
                } else {
                    status_html += 'Processing...';
                }
                
                status_html += '</div>';
                $('#openhcs-status').html(status_html);
            },
            error: function() {
                clearInterval(poll_interval);
            }
        });
        
    }, 2000);  // Poll every 2 seconds
}

/**
 * Load example pipeline code
 */
function loadExamplePipeline() {
    var example = `from openhcs.processing.steps import FunctionStep
from openhcs.processing.gpu_functions import gaussian_filter, max_projection

# Define pipeline steps
pipeline_steps = [
    FunctionStep(func=gaussian_filter, sigma=2.0),
    FunctionStep(func=max_projection)
]`;

    $('#openhcs-pipeline-code').val(example);
}

/**
 * Update server status display
 */
function updateServerStatus() {
    $.ajax({
        url: '/omero_openhcs/server-status/',
        method: 'GET',
        success: function(response) {
            if (response.type === 'pong' && response.ready) {
                // Server is online
                $('#server-status-icon').text('‚úÖ').addClass('status-online').removeClass('status-offline');

                var statusHtml = '<div>';
                statusHtml += '<strong>Status:</strong> Online<br>';
                statusHtml += '<strong>Uptime:</strong> ' + formatUptime(response.uptime || 0) + '<br>';
                statusHtml += '<strong>Active Executions:</strong> ' + (response.active_executions || 0) + '<br>';

                // Display workers if available
                if (response.workers && response.workers.length > 0) {
                    statusHtml += '<strong>Workers:</strong> ' + response.workers.length + '<br>';
                    statusHtml += '<div class="openhcs-worker-list">';

                    response.workers.forEach(function(worker) {
                        var cpu = worker.cpu_percent ? worker.cpu_percent.toFixed(1) + '%' : 'N/A';
                        var mem = worker.memory_mb ? worker.memory_mb.toFixed(0) + 'MB' : 'N/A';
                        statusHtml += '<div class="openhcs-worker-item">';
                        statusHtml += '‚öôÔ∏è PID ' + worker.pid + ' | CPU: ' + cpu + ' | Mem: ' + mem;
                        statusHtml += '</div>';
                    });

                    statusHtml += '</div>';
                } else {
                    statusHtml += '<strong>Workers:</strong> 0 (idle)<br>';
                }

                // Display running executions if available
                if (response.running_executions && response.running_executions.length > 0) {
                    statusHtml += '<br><strong>Running Jobs:</strong><br>';
                    statusHtml += '<div class="openhcs-worker-list">';

                    response.running_executions.forEach(function(exec) {
                        var elapsed = exec.elapsed ? formatUptime(exec.elapsed) : 'N/A';
                        statusHtml += '<div class="openhcs-worker-item">';
                        statusHtml += 'üîÑ Plate ' + exec.plate_id + ' | ' + elapsed;
                        statusHtml += '</div>';
                    });

                    statusHtml += '</div>';
                }

                statusHtml += '</div>';
                $('#server-status-content').html(statusHtml);

            } else {
                // Server is offline or error
                $('#server-status-icon').text('‚ùå').addClass('status-offline').removeClass('status-online');
                $('#server-status-content').html(
                    '<div class="status-offline">' +
                    '<strong>Status:</strong> Offline<br>' +
                    'The execution server is not responding. Please start the server.' +
                    '</div>'
                );
            }
        },
        error: function() {
            // Connection error
            $('#server-status-icon').text('‚ùå').addClass('status-offline').removeClass('status-online');
            $('#server-status-content').html(
                '<div class="status-offline">' +
                '<strong>Status:</strong> Connection Error<br>' +
                'Cannot connect to execution server at localhost:7777' +
                '</div>'
            );
        }
    });
}

/**
 * Format uptime in human-readable format
 */
function formatUptime(seconds) {
    if (seconds < 60) {
        return Math.floor(seconds) + 's';
    } else if (seconds < 3600) {
        return Math.floor(seconds / 60) + 'm ' + Math.floor(seconds % 60) + 's';
    } else {
        var hours = Math.floor(seconds / 3600);
        var minutes = Math.floor((seconds % 3600) / 60);
        return hours + 'h ' + minutes + 'm';
    }
}

</script>

