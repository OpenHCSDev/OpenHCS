name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode'
        required: true
        default: 'cpu-only'
        type: choice
        options:
        - cpu-only
        - full-coverage

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        backend: [disk, zarr]
        microscope: [ImageXpress, OperaPhenix]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run CPU-only integration tests
        if: github.event.inputs.test_mode == 'cpu-only' || github.event.inputs.test_mode == ''
        env:
          OPENHCS_CPU_ONLY: true
        run: |
          python -m pytest tests/integration/ \
                --it-backends ${{ matrix.backend }} \
                --it-microscopes ${{ matrix.microscope }} \
                --it-dims 3d \
                --it-exec-mode multiprocessing \
                -v --tb=short

      - name: Run full coverage integration tests
        if: github.event.inputs.test_mode == 'full-coverage'
        run: |
          python -m pytest tests/integration/ \
                --it-backends ${{ matrix.backend }} \
                --it-microscopes ${{ matrix.microscope }} \
                --it-dims all \
                --it-exec-mode all \
                -v --tb=short

  integration-tests-focused:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run focused CPU-only integration tests (default 4 combinations)
        env:
          OPENHCS_CPU_ONLY: true
        run: |
          python -m pytest tests/integration/ \
                --it-backends disk,zarr \
                --it-microscopes ImageXpress,OperaPhenix \
                --it-dims 3d \
                --it-exec-mode multiprocessing \
                -v --tb=short

  # Test PyPI-style installation (build wheel and install from it)
  pypi-installation-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheel
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Test base installation (no extras)
        run: |
          python -m venv test_base
          source test_base/bin/activate
          WHEEL=$(ls dist/*.whl)
          pip install "$WHEEL"
          python -c "import openhcs; print(f'OpenHCS {openhcs.__version__} imported successfully')"
          deactivate
          rm -rf test_base

      - name: Test GUI installation (dependencies only)
        run: |
          python -m venv test_gui
          source test_gui/bin/activate
          WHEEL=$(ls dist/*.whl)
          pip install "${WHEEL}[gui]"
          # Just verify dependencies installed, can't test GUI imports without X11/EGL
          python -c "import openhcs; print(f'OpenHCS {openhcs.__version__} with GUI dependencies installed')"
          deactivate
          rm -rf test_gui

      - name: Test dev installation
        run: |
          python -m venv test_dev
          source test_dev/bin/activate
          WHEEL=$(ls dist/*.whl)
          pip install "${WHEEL}[dev]"
          python -c "import pytest; import openhcs; print('Dev dependencies OK')"
          deactivate
          rm -rf test_dev

  omero-integration-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install pre-built zeroc-ice wheel from Glencoe Software
          pip install https://github.com/glencoesoftware/zeroc-ice-py-linux-x86_64/releases/download/20240202/zeroc_ice-3.6.5-cp311-cp311-manylinux_2_28_x86_64.whl
          pip install -e ".[dev,omero]"

      - name: Run OMERO integration tests (auto-starts Docker + OMERO)
        env:
          OPENHCS_CPU_ONLY: true
        run: |
          python -m pytest tests/integration/ \
                --it-backends disk \
                --it-microscopes OMERO \
                --it-dims 3d \
                --it-exec-mode multiprocessing \
                --it-visualizers none \
                -v --tb=short -s --log-cli-level=INFO
        timeout-minutes: 15

      - name: Show OMERO logs on failure
        if: failure()
        run: |
          echo "=== OMERO Server Logs ==="
          sudo docker compose -f openhcs/omero/docker-compose.yml logs omeroserver || true
          echo "=== OMERO Web Logs ==="
          sudo docker compose -f openhcs/omero/docker-compose.yml logs omeroweb || true
          echo "=== Database Logs ==="
          sudo docker compose -f openhcs/omero/docker-compose.yml logs database || true

      - name: Cleanup OMERO containers
        if: always()
        run: |
          cd openhcs/omero
          sudo docker compose down -v || true
