name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode'
        required: true
        default: 'cpu-only'
        type: choice
        options:
        - cpu-only
        - full-coverage

jobs:
  # Group 1: Python version boundary testing (4 jobs)
  # Test oldest (3.11) and newest (3.14) Python on both OSes
  python-boundary-tests:
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        # Boundary testing: oldest and newest supported versions
        # Python 3.14 uses NumPy < 2.2 due to histogram/bincount bug (see pyproject.toml and issue #34)
        python-version: ["3.11", "3.14"]
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run boundary version tests
        env:
          OPENHCS_CPU_ONLY: true
        run: |
          python -m pytest tests/integration/ --it-backends disk --it-microscopes ImageXpress --it-dims 3d --it-exec-mode multiprocessing -v --tb=short

  # Group 2: Backend and microscope coverage (4 jobs)
  # Test all backend/microscope combinations on both OSes with Python 3.12
  backend-microscope-tests:
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        backend: [disk, zarr]
        microscope: [ImageXpress, OperaPhenix]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run backend/microscope combination tests
        env:
          OPENHCS_CPU_ONLY: true
        run: |
          python -m pytest tests/integration/ --it-backends ${{ matrix.backend }} --it-microscopes ${{ matrix.microscope }} --it-dims 3d --it-exec-mode multiprocessing -v --tb=short

  # Group 3: OMERO testing on Linux (2 jobs)
  # Test OMERO on Linux with Python 3.11 and 3.12
  # Python 3.13+ not supported yet - zeroc-ice pre-built wheels only available up to Python 3.12
  # See: https://github.com/glencoesoftware/zeroc-ice-py-linux-x86_64/releases/tag/20240202
  omero-tests-linux:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]
        include:
          - python-version: "3.11"
            ice-wheel: "https://github.com/glencoesoftware/zeroc-ice-py-linux-x86_64/releases/download/20240202/zeroc_ice-3.6.5-cp311-cp311-manylinux_2_28_x86_64.whl"
          - python-version: "3.12"
            ice-wheel: "https://github.com/glencoesoftware/zeroc-ice-py-linux-x86_64/releases/download/20240202/zeroc_ice-3.6.5-cp312-cp312-manylinux_2_28_x86_64.whl"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install pre-built zeroc-ice wheel from Glencoe Software (OMERO maintainers)
          # Building from source fails on Python 3.11+ due to setuptools compatibility issues
          pip install ${{ matrix.ice-wheel }}
          pip install -e ".[dev,omero]"

      - name: Run OMERO integration tests (auto-starts Docker + OMERO)
        env:
          OPENHCS_CPU_ONLY: true
        run: |
          python -m pytest tests/integration/ --it-backends disk --it-microscopes OMERO --it-dims 3d --it-exec-mode multiprocessing --it-visualizers none -v --tb=short -s --log-cli-level=INFO
        timeout-minutes: 15

      - name: Show OMERO logs on failure
        if: failure()
        run: |
          echo "=== OMERO Server Logs ==="
          sudo docker compose -f openhcs/omero/docker-compose.yml logs omeroserver || true
          echo "=== OMERO Web Logs ==="
          sudo docker compose -f openhcs/omero/docker-compose.yml logs omeroweb || true
          echo "=== Database Logs ==="
          sudo docker compose -f openhcs/omero/docker-compose.yml logs database || true

      - name: Cleanup OMERO containers
        if: always()
        run: |
          cd openhcs/omero
          sudo docker compose down -v || true

  # Code quality checks (linting, formatting, type checking)
  code-quality:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black mypy

      - name: Run ruff (linting)
        continue-on-error: true  # Don't fail CI on linting errors initially
        run: |
          ruff check openhcs/ --output-format=github

      - name: Run black (formatting check)
        continue-on-error: true  # Don't fail CI on formatting errors initially
        run: |
          black --check openhcs/

      - name: Run mypy (type checking)
        continue-on-error: true  # Don't fail CI on type errors initially
        run: |
          mypy openhcs/ --ignore-missing-imports --no-strict-optional

  # Test PyPI-style installation across Python versions
  pypi-installation-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build wheel
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Test headless installation (base - no extras)
        run: |
          python -m venv test_headless
          source test_headless/bin/activate
          WHEEL=$(ls dist/*.whl)
          pip install "$WHEEL"
          # Verify core OpenHCS works without GUI
          python -c "import openhcs; from openhcs.core.pipeline import Pipeline; print(f'✓ OpenHCS {openhcs.__version__} headless installation OK')"
          deactivate
          rm -rf test_headless

      - name: Test GUI dependencies installation
        run: |
          python -m venv test_gui
          source test_gui/bin/activate
          WHEEL=$(ls dist/*.whl)
          pip install "${WHEEL}[gui]"
          # Verify GUI dependencies installed (can't import PyQt6 without X11/EGL in CI)
          python -c "import openhcs; import psutil; import GPUtil; print(f'✓ OpenHCS {openhcs.__version__} GUI dependencies installed')"
          deactivate
          rm -rf test_gui

      - name: Test dev dependencies installation
        run: |
          python -m venv test_dev
          source test_dev/bin/activate
          WHEEL=$(ls dist/*.whl)
          pip install "${WHEEL}[dev]"
          python -c "import pytest; import openhcs; print('✓ Dev dependencies OK')"
          deactivate
          rm -rf test_dev

  # Run integration tests against wheel installation
  wheel-integration-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheel
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Install wheel and run integration tests
        env:
          OPENHCS_CPU_ONLY: true
        run: |
          python -m venv test_wheel
          source test_wheel/bin/activate
          WHEEL=$(ls dist/*.whl)
          pip install "${WHEEL}[dev]"

          # Run focused integration test (1 backend/microscope combo to verify packaging)
          python -m pytest tests/integration/ \
                --it-backends disk \
                --it-microscopes ImageXpress \
                --it-dims 3d \
                --it-exec-mode multiprocessing \
                -v --tb=short

          deactivate
          rm -rf test_wheel


