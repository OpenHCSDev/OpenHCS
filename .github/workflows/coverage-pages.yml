name: Combined Coverage Report

on:
  workflow_run:
    workflows: ["Integration Tests"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write  # Needed for badge commit
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  combine-and-deploy:
    runs-on: ubuntu-latest
    # Only run if integration tests completed (even if some failed)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install coverage tools
        run: |
          python -m pip install --upgrade pip
          pip install coverage[toml] genbadge[coverage]

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-reports/
          merge-multiple: false

      - name: Combine coverage reports
        run: |
          mkdir -p site

          # Find all .coverage files
          echo "=== Coverage files found ==="
          find coverage-reports -name ".coverage*" -type f

          # Rename all .coverage files to have unique names for combining
          # coverage combine expects files named .coverage.*
          cd coverage-reports
          for dir in */; do
            if [ -f "$dir/.coverage" ]; then
              # Extract job name from directory
              job_name=$(basename "$dir")
              mv "$dir/.coverage" ".coverage.$job_name"
              echo "Renamed $dir/.coverage to .coverage.$job_name"
            fi
            if [ -f "$dir/.coverage.wheel" ]; then
              mv "$dir/.coverage.wheel" ".coverage.wheel"
              echo "Found wheel coverage file"
            fi
          done
          cd ..

          # Combine all .coverage files
          coverage combine coverage-reports/.coverage.* || echo "Coverage combine completed with warnings"

          # Generate combined reports
          coverage xml -o coverage.xml
          coverage html -d site/coverage

          echo "=== Combined coverage report generated ==="
          ls -la coverage.xml site/coverage/



      - name: Generate coverage badge
        run: |
          mkdir -p .github/badges
          genbadge coverage -i coverage.xml -o .github/badges/coverage.svg -n "coverage report"

      - name: Create index.html and README
        run: |
          # Create index.html for redirection
          cat > site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
            <head>
              <meta http-equiv="refresh" content="0; url=./coverage/">
              <title>Redirecting to coverage report...</title>
            </head>
            <body>
              <p>Redirecting to coverage report... <a href="./coverage/">Click here if not redirected</a></p>
            </body>
          </html>
          EOF

          # Create README.md in the site directory
          cat > site/README.md << 'EOF'
          # OpenHCS Code Coverage Reports

          This site contains the combined code coverage reports for the [OpenHCS](https://github.com/trissim/openhcs) project.

          ## Navigation

          - [Coverage Report](./coverage/): View the HTML coverage report

          ## About

          These reports are automatically generated by GitHub Actions and combine coverage from all integration test jobs:
          - Python boundary tests (3.11, 3.13) across Linux, Windows, macOS
          - Backend/microscope combinations (disk, zarr × ImageXpress, OperaPhenix) across all OSes
          - OMERO tests (Linux only, Python 3.11-3.12)
          - Wheel installation tests

          The combined coverage shows the total percentage of code covered by all test suites together.

          Last updated: $(date)
          EOF

      # Disabled: Auto-committing badges causes push conflicts
      # - name: Commit and push if coverage badge changed
      #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      #   run: |
      #     git config --local user.email "github-actions[bot]@users.noreply.github.com"
      #     git config --local user.name "github-actions[bot]"
      #     git add .github/badges/coverage.svg -f
      #     git commit -m "chore: update coverage badge" || exit 0
      #     git push

      - name: Check GitHub Pages status
        run: |
          echo "⚠️ IMPORTANT: Make sure GitHub Pages is enabled in your repository settings!"
          echo "Go to https://github.com/trissim/openhcs/settings/pages"
          echo "Set 'Source' to 'GitHub Actions' to enable GitHub Pages deployment."

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'site'
          retention-days: 1

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        timeout-minutes: 10
